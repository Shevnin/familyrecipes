<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="–†–µ—Ü–µ–ø—Ç—ã">
  <meta name="mobile-web-app-capable" content="yes">
  <title>–°–µ–º–µ–π–Ω—ã–µ —Ä–µ—Ü–µ–ø—Ç—ã</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,opsz,wght@0,9..144,400;0,9..144,600;0,9..144,700;1,9..144,400&family=IBM+Plex+Sans:wght@500;600&family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #F2EEE6;
      --bg-accent: #E9E2D5;
      --surface: #FFFCF7;
      --surface-2: #F8F3EA;
      --text: #1B1A18;
      --muted: #746E63;
      --line: #DCCFB8;
      --primary: #C26A2E;
      --primary-2: #A95524;
      --mom: #D95A63;
      --dad: #2E6FD8;
      --bro: #3D9B63;
      --sis: #D6A800;
      --radius-card: 20px;
      --radius-input: 14px;
      --radius-btn: 16px;
      --shadow-card: 0 1px 4px rgba(27,26,24,.05), 0 4px 16px rgba(27,26,24,.04);
      --font-display: 'Fraunces', Georgia, serif;
      --font-body: 'Manrope', -apple-system, sans-serif;
      --font-label: 'IBM Plex Sans', -apple-system, sans-serif;
      --transition: 180ms ease;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: var(--font-body);
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: env(safe-area-inset-top) 0 env(safe-area-inset-bottom);
      -webkit-font-smoothing: antialiased;
    }

    .screen { display: none; }
    .screen.active { display: block; }
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }

    /* --- Header --- */
    .header {
      background: var(--surface);
      padding: 20px 20px 16px;
      border-bottom: 1px solid var(--line);
      position: sticky; top: 0; z-index: 10;
    }
    .header h1 {
      font-family: var(--font-display);
      font-size: 34px; font-weight: 700;
      color: var(--text);
      letter-spacing: -0.3px;
    }
    .header p {
      font-family: var(--font-body);
      font-size: 14px; color: var(--muted);
      margin-top: 2px; font-weight: 400;
    }

    /* --- Segment control tabs --- */
    .tabs {
      display: flex;
      background: var(--surface);
      padding: 8px 20px 12px;
      position: sticky; top: 73px; z-index: 9;
      border-bottom: 1px solid var(--line);
    }
    .tabs-inner {
      display: flex; width: 100%;
      background: var(--bg-accent);
      border-radius: 12px; padding: 3px;
    }
    .tab-btn {
      flex: 1; padding: 9px 0;
      font-family: var(--font-body);
      font-size: 14px; font-weight: 600;
      background: none; color: var(--muted);
      border: none; border-radius: 10px;
      cursor: pointer;
      transition: all var(--transition);
      -webkit-tap-highlight-color: transparent;
    }
    .tab-btn.active {
      background: var(--surface);
      color: var(--text);
      box-shadow: 0 1px 3px rgba(27,26,24,.08);
    }

    /* --- Content area --- */
    .content { padding: 20px 20px 100px; }

    /* --- Form elements --- */
    label {
      display: block;
      font-family: var(--font-label);
      font-size: 12px; font-weight: 600;
      color: var(--muted);
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.6px;
    }
    input[type="text"], textarea {
      width: 100%; padding: 14px 16px;
      font-family: var(--font-body);
      font-size: 16px; color: var(--text);
      border: 1px solid var(--line);
      border-radius: var(--radius-input);
      background: var(--surface);
      margin-bottom: 16px;
      transition: border-color var(--transition), box-shadow var(--transition);
      -webkit-appearance: none;
    }
    input[type="text"]::placeholder, textarea::placeholder {
      color: var(--muted); opacity: 0.6;
    }
    input[type="text"]:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(194,106,46,.12);
    }
    textarea { resize: none; min-height: 180px; line-height: 1.6; }

    .btn {
      display: block; width: 100%;
      padding: 15px; font-size: 16px; font-weight: 700;
      font-family: var(--font-body);
      background: var(--primary); color: #fff;
      border: none; border-radius: var(--radius-btn);
      cursor: pointer; text-align: center;
      transition: background var(--transition), transform 100ms ease;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:active { background: var(--primary-2); transform: scale(0.98); }
    .btn-secondary { background: var(--bg-accent); color: var(--text); }
    .btn-secondary:active { background: var(--line); }

    /* --- Link box --- */
    .link-box {
      margin-top: 16px; padding: 16px;
      background: #EDF5E8;
      border: 1px solid #C5DCBA;
      border-radius: var(--radius-input);
      word-break: break-all; font-size: 14px;
      color: var(--text);
      cursor: pointer; position: relative;
      transition: background var(--transition);
      -webkit-tap-highlight-color: transparent;
    }
    .link-box:active { background: #DDE9D4; }
    .link-hint {
      font-family: var(--font-label);
      font-size: 11px; color: var(--muted);
      margin-top: 8px; text-transform: uppercase;
      letter-spacing: 0.4px;
    }

    /* --- Recipe card --- */
    .recipe-card {
      background: var(--surface);
      border: 1px solid var(--line);
      border-radius: var(--radius-card);
      padding: 16px 18px;
      margin-bottom: 12px;
      box-shadow: var(--shadow-card);
      cursor: pointer;
      position: relative;
      overflow: hidden;
      transition: transform var(--transition), box-shadow var(--transition);
      -webkit-tap-highlight-color: transparent;
    }
    .recipe-card::before {
      content: '';
      position: absolute; left: 0; top: 0; bottom: 0;
      width: 4px;
      background: var(--author-color, var(--muted));
    }
    .recipe-card:active {
      transform: scale(0.985);
      box-shadow: 0 1px 2px rgba(27,26,24,.04);
    }
    .recipe-card-title {
      font-family: var(--font-display);
      font-size: 19px; font-weight: 600;
      margin-bottom: 6px; padding-left: 2px;
      letter-spacing: -0.1px;
    }
    .recipe-card-meta {
      display: flex; gap: 8px; align-items: center;
      padding-left: 2px;
    }
    .author-chip {
      display: inline-flex; align-items: center;
      font-family: var(--font-label);
      font-size: 12px; font-weight: 600;
      padding: 3px 10px; border-radius: 8px;
      letter-spacing: 0.2px;
    }
    .recipe-card-date {
      font-family: var(--font-label);
      font-size: 12px; color: var(--muted);
      font-weight: 500;
    }

    /* --- Badges --- */
    .badge {
      font-family: var(--font-label);
      font-size: 11px; font-weight: 600;
      padding: 3px 9px; border-radius: 8px;
      display: inline-block;
      letter-spacing: 0.2px;
    }
    .badge-pending { background: #FFF0DC; color: #A85F00; }
    .badge-fulfilled { background: #E4F2E0; color: #2A6E28; }

    /* --- Request item --- */
    .request-section-title {
      font-family: var(--font-display);
      font-size: 22px; font-weight: 600;
      color: var(--text);
      margin-top: 32px; margin-bottom: 14px;
      letter-spacing: -0.1px;
    }
    .request-item {
      background: var(--surface);
      border: 1px solid var(--line);
      border-radius: var(--radius-card);
      padding: 14px 16px; margin-bottom: 10px;
      box-shadow: var(--shadow-card);
      position: relative;
    }
    .request-delete {
      position: absolute; top: 10px; right: 12px;
      width: 28px; height: 28px;
      display: flex; align-items: center; justify-content: center;
      background: none; border: none;
      font-size: 15px; color: var(--muted);
      cursor: pointer; border-radius: 8px;
      transition: background var(--transition), color var(--transition);
      -webkit-tap-highlight-color: transparent;
    }
    .request-delete:active { background: rgba(183,58,58,.1); color: #B73A3A; }
    .request-item-title {
      font-family: var(--font-display);
      font-size: 16px; font-weight: 600;
      margin-bottom: 4px;
    }
    .request-item-info {
      font-size: 13px; color: var(--muted);
      margin-bottom: 8px;
      display: flex; gap: 6px; align-items: center;
      flex-wrap: wrap;
    }
    .request-item-link {
      font-size: 13px; color: var(--primary);
      word-break: break-all; cursor: pointer;
      transition: opacity var(--transition);
    }
    .request-item-link:active { opacity: 0.6; }

    /* --- Empty state --- */
    .empty-state { text-align: center; padding: 60px 20px; }
    .empty-state-icon { font-size: 48px; margin-bottom: 12px; opacity: 0.35; }
    .empty-state-text {
      font-size: 15px; color: var(--muted); line-height: 1.5;
    }

    /* --- Detail view --- */
    .detail-back {
      display: inline-flex; align-items: center; gap: 4px;
      font-family: var(--font-body);
      font-size: 15px; font-weight: 600;
      color: var(--primary); background: none; border: none;
      cursor: pointer; padding: 0; margin-bottom: 20px;
      transition: opacity var(--transition);
    }
    .detail-back:active { opacity: 0.6; }
    .detail-title {
      font-family: var(--font-display);
      font-size: 26px; font-weight: 700;
      margin-bottom: 6px;
      letter-spacing: -0.2px;
    }
    .detail-author {
      font-size: 14px; color: var(--muted);
      margin-bottom: 6px;
    }
    .detail-author-chip {
      display: inline-flex; align-items: center;
      font-family: var(--font-label);
      font-size: 12px; font-weight: 600;
      padding: 3px 10px; border-radius: 8px;
      letter-spacing: 0.2px;
      margin-bottom: 20px;
    }
    .section-label {
      font-family: var(--font-label);
      font-size: 11px; font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: var(--muted);
      margin-bottom: 10px;
    }
    .original-block {
      background: var(--surface-2);
      border-left: 3px solid var(--line);
      padding: 16px; border-radius: var(--radius-input);
      white-space: pre-wrap;
      font-size: 15px; line-height: 1.7;
      margin-bottom: 24px;
      font-style: italic;
      color: var(--text);
    }
    .structured { font-size: 15px; line-height: 1.7; color: var(--text); }
    .structured h3 {
      font-family: var(--font-display);
      font-size: 17px; font-weight: 600;
      margin: 18px 0 8px;
    }
    .structured h3:first-child { margin-top: 0; }
    .structured ul, .structured ol { padding-left: 22px; }
    .structured li { margin-bottom: 6px; }

    /* --- Reply screen --- */
    .reply-screen {
      min-height: 100vh; padding: 20px;
      display: flex; flex-direction: column;
      background: var(--bg);
    }
    .reply-header { margin-bottom: 28px; }
    .reply-header h1 {
      font-family: var(--font-display);
      font-size: 28px; font-weight: 700;
      color: var(--text);
    }
    .reply-header p {
      font-size: 14px; color: var(--muted); margin-top: 4px;
    }
    .reply-info {
      background: var(--surface);
      border-left: 3px solid var(--primary);
      padding: 14px 16px; border-radius: var(--radius-input);
      margin-bottom: 24px; font-size: 15px;
    }
    .reply-info strong {
      display: block;
      font-family: var(--font-label);
      font-size: 11px; color: var(--muted);
      margin-bottom: 4px; font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.5px;
    }
    .reply-success, .reply-error {
      flex: 1; display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      text-align: center; padding: 40px 20px;
    }
    .reply-success h2 {
      font-family: var(--font-display);
      font-size: 24px; color: #2A6E28; margin-bottom: 8px;
    }
    .reply-error h2 {
      font-family: var(--font-display);
      font-size: 24px; color: #B73A3A; margin-bottom: 8px;
    }
    .reply-success p, .reply-error p {
      font-size: 15px; color: var(--muted);
    }

    .status-msg {
      text-align: center; font-size: 14px; font-weight: 500;
      margin-top: 12px; min-height: 20px;
    }
    .status-ok { color: #2A6E28; }
    .status-err { color: #B73A3A; }

    /* --- Divider --- */
    .form-divider {
      height: 1px; background: var(--line);
      margin: 28px 0;
    }
  </style>
</head>
<body>

  <!-- ====== REPLY SCREEN (by link) ====== -->
  <div class="screen" id="screen-reply">
    <div class="reply-screen" id="reply-container"></div>
  </div>

  <!-- ====== MAIN SCREEN (requester) ====== -->
  <div class="screen active" id="screen-main">
    <div class="header">
      <h1>–°–µ–º–µ–π–Ω—ã–µ —Ä–µ—Ü–µ–ø—Ç—ã</h1>
      <p>–°–æ–±–∏—Ä–∞–π —Ä–µ—Ü–µ–ø—Ç—ã —É –±–ª–∏–∑–∫–∏—Ö</p>
    </div>
    <div class="tabs">
      <div class="tabs-inner">
        <button class="tab-btn active" data-tab="recipes">–†–µ—Ü–µ–ø—Ç—ã</button>
        <button class="tab-btn" data-tab="request">–ó–∞–ø—Ä–æ—Å–∏—Ç—å</button>
      </div>
    </div>

    <!-- Tab: Recipes -->
    <div class="content tab-panel active" id="panel-recipes">
      <div id="recipe-list"></div>
      <div id="recipe-detail" style="display:none"></div>
    </div>

    <!-- Tab: Request -->
    <div class="content tab-panel" id="panel-request">
      <label for="req-target">–£ –∫–æ–≥–æ –ø—Ä–æ—Å–∏–º</label>
      <input type="text" id="req-target" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ú–∞–º–∞">
      <label for="req-title">–ö–∞–∫–æ–µ –±–ª—é–¥–æ</label>
      <input type="text" id="req-title" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ë–æ—Ä—â">
      <button class="btn" id="create-link">–°–æ–∑–¥–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
      <div id="link-result"></div>
      <div class="form-divider"></div>
      <div class="request-section-title">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤</div>
      <div id="request-list"></div>
    </div>
  </div>

  <script>
    // ========== Helpers ==========
    function esc(str) {
      const d = document.createElement('div');
      d.textContent = str;
      return d.innerHTML;
    }

    function loadJSON(key) {
      try { return JSON.parse(localStorage.getItem(key) || '[]'); } catch { return []; }
    }

    function saveJSON(key, data) {
      localStorage.setItem(key, JSON.stringify(data));
    }

    function buildLink(token) {
      return window.location.href.split('?')[0] + '?r=' + token;
    }

    function formatDate(iso) {
      return new Date(iso).toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' });
    }

    // ========== Author color mapping ==========
    const authorColors = {
      '–ú–∞–º–∞': { var: 'var(--mom)', bg: 'rgba(217,90,99,.1)', text: '#B5404A' },
      '–ü–∞–ø–∞': { var: 'var(--dad)', bg: 'rgba(46,111,216,.1)', text: '#1E56A8' },
      '–ë—Ä–∞—Ç': { var: 'var(--bro)', bg: 'rgba(61,155,99,.1)', text: '#2C7A4C' },
      '–°–µ—Å—Ç—Ä–∞': { var: 'var(--sis)', bg: 'rgba(214,168,0,.1)', text: '#9A7800' },
    };
    const defaultAuthor = { var: 'var(--muted)', bg: 'rgba(116,110,99,.08)', text: '#5A554B' };

    function getAuthor(sender) {
      return authorColors[sender] || defaultAuthor;
    }

    // ========== Recipe parser ==========
    function parseRecipe(text) {
      const lines = text.split('\n').map(l => l.trim()).filter(l => l.length > 0);
      if (lines.length === 0) return '<p style="color:var(--muted)">–ü—É—Å—Ç–æ</p>';

      const unitPattern = /\d+\s*(–≥|–≥—Ä|–∫–≥|–º–ª|–ª|—à—Ç|—Å—Ç\.?\s*–ª|—á\.?\s*–ª|—Å—Ç–∞–∫–∞–Ω|—â–µ–ø–æ—Ç|–ø—É—á–æ–∫|–∑—É–±—á|–¥–æ–ª–µ–∫|–¥–æ–ª—å–∫–∞|–±–∞–Ω–∫|–ø–∞—á–∫|—É–ø–∞–∫–æ–≤–∫)/i;
      const tastePattern = /–ø–æ –≤–∫—É—Å—É|–Ω–∞ –≥–ª–∞–∑/i;

      const ingredients = [];
      const steps = [];

      for (const line of lines) {
        if (unitPattern.test(line) || tastePattern.test(line)) {
          ingredients.push(line);
        } else {
          steps.push(line);
        }
      }

      let html = '';
      if (ingredients.length > 0) {
        html += '<h3>–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã</h3><ul>';
        for (const ing of ingredients) html += `<li>${esc(ing)}</li>`;
        html += '</ul>';
      }
      if (steps.length > 0) {
        html += '<h3>–®–∞–≥–∏</h3><ol>';
        for (const step of steps) html += `<li>${esc(step)}</li>`;
        html += '</ol>';
      }
      return html || '<p style="color:var(--muted)">–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞–∑–æ–±—Ä–∞—Ç—å</p>';
    }

    // ========== Reply flow (?r=token) ==========
    const urlParams = new URLSearchParams(window.location.search);
    const replyToken = urlParams.get('r');

    if (replyToken) {
      document.getElementById('screen-main').classList.remove('active');
      const replyScreen = document.getElementById('screen-reply');
      replyScreen.classList.add('active');
      const container = document.getElementById('reply-container');

      const requests = loadJSON('recipe_requests');
      const request = requests.find(r => r.token === replyToken);

      if (!request) {
        container.innerHTML = `
          <div class="reply-error">
            <h2>–ó–∞–ø—Ä–æ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω</h2>
            <p>–°—Å—ã–ª–∫–∞ –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞ –∏–ª–∏ –∑–∞–ø—Ä–æ—Å –±—ã–ª —É–¥–∞–ª—ë–Ω.</p>
          </div>`;
      } else if (request.status === 'fulfilled') {
        container.innerHTML = `
          <div class="reply-success">
            <h2>–†–µ—Ü–µ–ø—Ç —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω</h2>
            <p>–ù–∞ —ç—Ç–æ—Ç –∑–∞–ø—Ä–æ—Å —É–∂–µ –æ—Ç–≤–µ—Ç–∏–ª–∏. –°–ø–∞—Å–∏–±–æ!</p>
          </div>`;
      } else {
        container.innerHTML = `
          <div class="reply-header">
            <h1>–î–µ–ª–∏–º—Å—è</h1>
            <p>–í–∞—Å –ø–æ–ø—Ä–æ—Å–∏–ª–∏ –ø–æ–¥–µ–ª–∏—Ç—å—Å—è —Ä–µ—Ü–µ–ø—Ç–æ–º</p>
          </div>
          <div class="reply-info">
            <strong>–ü—Ä–æ—Å—è—Ç</strong>
            ${esc(request.requested_title)}
          </div>
          <label for="reply-title">–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ—Ü–µ–ø—Ç–∞</label>
          <input type="text" id="reply-title" value="${esc(request.requested_title)}">
          <label for="reply-body">–†–µ—Ü–µ–ø—Ç</label>
          <textarea id="reply-body" placeholder="–ë–µ—Ä—ë—à—å ..."></textarea>
          <button class="btn" id="reply-submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–µ—Ü–µ–ø—Ç</button>
          <div class="status-msg" id="reply-status"></div>`;

        document.getElementById('reply-submit').addEventListener('click', () => {
          const body = document.getElementById('reply-body').value.trim();
          const title = document.getElementById('reply-title').value.trim();
          const statusEl = document.getElementById('reply-status');

          if (!body) {
            statusEl.className = 'status-msg status-err';
            statusEl.textContent = '–ù–∞–ø–∏—à–∏—Ç–µ —Ä–µ—Ü–µ–ø—Ç –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π';
            return;
          }

          // Save response
          const responses = loadJSON('recipe_responses');
          responses.push({
            token: replyToken,
            title: title || request.requested_title,
            body: body,
            sender: request.target_person,
            created_at: new Date().toISOString()
          });
          saveJSON('recipe_responses', responses);

          // Update request status
          request.status = 'fulfilled';
          saveJSON('recipe_requests', requests);

          container.innerHTML = `
            <div class="reply-success">
              <h2>–†–µ—Ü–µ–ø—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!</h2>
              <p>–°–ø–∞—Å–∏–±–æ! –†–µ—Ü–µ–ø—Ç ¬´${esc(title || request.requested_title)}¬ª —Å–æ—Ö—Ä–∞–Ω—ë–Ω.</p>
            </div>`;
        });
      }
    }

    // ========== Main screen ==========
    if (!replyToken) {
      // Tabs
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
          document.getElementById('panel-' + btn.dataset.tab).classList.add('active');
          if (btn.dataset.tab === 'recipes' && recipeDetailEl.style.display !== 'none') {
            renderRecipeList();
          }
        });
      });

      const recipeListEl = document.getElementById('recipe-list');
      const recipeDetailEl = document.getElementById('recipe-detail');

      // Demo recipes
      const demoRecipes = [
        { id: 'demo-1', title: '–Ø–∏—á–Ω–∏—Ü–∞ –ø–æ-–ø–æ–ª—å—Å–∫–∏', sender: '–ü–∞–ø–∞', source: 'demo',
          body: '–Ø–π—Ü–∞ 3 —à—Ç\n–ú–∞—Å–ª–æ —Å–ª–∏–≤–æ—á–Ω–æ–µ 20 –≥\n–•–ª–µ–± –±–µ–ª—ã–π 2 —à—Ç\n–°–æ–ª—å –ø–æ –≤–∫—É—Å—É\n–†–∞–∑–æ–≥—Ä–µ—Ç—å —Å–∫–æ–≤–æ—Ä–æ–¥—É —Å –º–∞—Å–ª–æ–º\n–†–∞–∑–±–∏—Ç—å —è–π—Ü–∞, –Ω–µ –ø–µ—Ä–µ–º–µ—à–∏–≤–∞—Ç—å\n–ù–∞–∫—Ä—ã—Ç—å –∫—Ä—ã—à–∫–æ–π –Ω–∞ 3 –º–∏–Ω—É—Ç—ã\n–ü–æ–¥–∞–≤–∞—Ç—å —Å –ø–æ–¥–∂–∞—Ä–µ–Ω–Ω—ã–º —Ö–ª–µ–±–æ–º' },
        { id: 'demo-2', title: '–ö–æ—Ç–ª–µ—Ç—ã —Å–≤–∏–Ω—ã–µ', sender: '–ü–∞–ø–∞', source: 'demo',
          body: '–°–≤–∏–Ω–∏–Ω–∞ 500 –≥\n–õ—É–∫ 1 —à—Ç\n–ß–µ—Å–Ω–æ–∫ 2 –∑—É–±—á\n–•–ª–µ–± 100 –≥\n–Ø–π—Ü–æ 1 —à—Ç\n–°–æ–ª—å –ø–æ –≤–∫—É—Å—É\n–ü–µ—Ä–µ–º–æ–ª–æ—Ç—å –º—è—Å–æ —Å –ª—É–∫–æ–º –∏ —á–µ—Å–Ω–æ–∫–æ–º\n–î–æ–±–∞–≤–∏—Ç—å —Ä–∞–∑–º–æ—á–µ–Ω–Ω—ã–π —Ö–ª–µ–± –∏ —è–π—Ü–æ\n–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –∫–æ—Ç–ª–µ—Ç—ã\n–û–±–∂–∞—Ä–∏—Ç—å –ø–æ 5 –º–∏–Ω—É—Ç —Å –∫–∞–∂–¥–æ–π —Å—Ç–æ—Ä–æ–Ω—ã\n–î–æ–≤–µ—Å—Ç–∏ –ø–æ–¥ –∫—Ä—ã—à–∫–æ–π 10 –º–∏–Ω—É—Ç' },
        { id: 'demo-3', title: '–ë–æ—Ä—â –≤—ã—Ö–æ–¥–Ω–æ–≥–æ –¥–Ω—è', sender: '–ú–∞–º–∞', source: 'demo',
          body: '–ì–æ–≤—è–¥–∏–Ω–∞ 400 –≥\n–°–≤—ë–∫–ª–∞ 1 —à—Ç\n–ö–∞—Ä—Ç–æ—à–∫–∞ 3 —à—Ç\n–ö–∞–ø—É—Å—Ç–∞ 300 –≥\n–ú–æ—Ä–∫–æ–≤—å 1 —à—Ç\n–õ—É–∫ 1 —à—Ç\n–¢–æ–º–∞—Ç–Ω–∞—è –ø–∞—Å—Ç–∞ 1 —Å—Ç –ª\n–í–æ–¥–∞ 2 –ª\n–°–æ–ª—å –ø–æ –≤–∫—É—Å—É\n–°–≤–∞—Ä–∏—Ç—å –±—É–ª—å–æ–Ω –∏–∑ –º—è—Å–∞ –ø–æ–ª—Ç–æ—Ä–∞ —á–∞—Å–∞\n–ù–∞—Ç–µ—Ä–µ—Ç—å —Å–≤—ë–∫–ª—É, –æ–±–∂–∞—Ä–∏—Ç—å —Å —Ç–æ–º–∞—Ç–Ω–æ–π –ø–∞—Å—Ç–æ–π\n–ö–∞—Ä—Ç–æ—à–∫—É –Ω–∞—Ä–µ–∑–∞—Ç—å –∫—É–±–∏–∫–∞–º–∏, –∫–∞–ø—É—Å—Ç—É –Ω–∞—à–∏–Ω–∫–æ–≤–∞—Ç—å\n–í –±—É–ª—å–æ–Ω –¥–æ–±–∞–≤–∏—Ç—å –∫–∞—Ä—Ç–æ—à–∫—É, –≤–∞—Ä–∏—Ç—å 10 –º–∏–Ω—É—Ç\n–î–æ–±–∞–≤–∏—Ç—å –∫–∞–ø—É—Å—Ç—É –∏ —Å–≤—ë–∫–ª—É, –≤–∞—Ä–∏—Ç—å –µ—â—ë 10 –º–∏–Ω—É—Ç\n–õ—É–∫ –∏ –º–æ—Ä–∫–æ–≤—å –æ–±–∂–∞—Ä–∏—Ç—å, –¥–æ–±–∞–≤–∏—Ç—å –≤ –±–æ—Ä—â\n–ü–æ—Å–æ–ª–∏—Ç—å, –¥–∞—Ç—å –Ω–∞—Å—Ç–æ—è—Ç—å—Å—è 20 –º–∏–Ω—É—Ç' },
        { id: 'demo-4', title: '–°—ã—Ä–Ω–∏–∫–∏ —É—Ç—Ä–µ–Ω–Ω–∏–µ', sender: '–°–µ—Å—Ç—Ä–∞', source: 'demo',
          body: '–¢–≤–æ—Ä–æ–≥ 400 –≥\n–Ø–π—Ü–æ 1 —à—Ç\n–°–∞—Ö–∞—Ä 2 —Å—Ç –ª\n–ú—É–∫–∞ 3 —Å—Ç –ª\n–°–æ–ª—å –Ω–∞ –≥–ª–∞–∑\n–°–º–µ—à–∞—Ç—å —Ç–≤–æ—Ä–æ–≥ —Å —è–π—Ü–æ–º –∏ —Å–∞—Ö–∞—Ä–æ–º\n–î–æ–±–∞–≤–∏—Ç—å –º—É–∫—É, –ø–µ—Ä–µ–º–µ—à–∞—Ç—å\n–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –ª–µ–ø—ë—à–∫–∏\n–û–±–∂–∞—Ä–∏—Ç—å –Ω–∞ —Å—Ä–µ–¥–Ω–µ–º –æ–≥–Ω–µ –ø–æ 3 –º–∏–Ω—É—Ç—ã —Å –∫–∞–∂–¥–æ–π —Å—Ç–æ—Ä–æ–Ω—ã\n–ü–æ–¥–∞–≤–∞—Ç—å —Å–æ —Å–º–µ—Ç–∞–Ω–æ–π' },
        { id: 'demo-5', title: '–ì—Ä–µ—á–∫–∞ –ø–æ-—Ñ–ª–æ—Ç—Å–∫–∏', sender: '–ë—Ä–∞—Ç', source: 'demo',
          body: '–ì—Ä–µ—á–∫–∞ 200 –≥\n–§–∞—Ä—à 300 –≥\n–õ—É–∫ 1 —à—Ç\n–ú–æ—Ä–∫–æ–≤—å 1 —à—Ç\n–ú–∞—Å–ª–æ —Ä–∞—Å—Ç–∏—Ç–µ–ª—å–Ω–æ–µ 2 —Å—Ç –ª\n–°–æ–ª—å –ø–æ –≤–∫—É—Å—É\n–°–≤–∞—Ä–∏—Ç—å –≥—Ä–µ—á–∫—É –¥–æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏\n–û–±–∂–∞—Ä–∏—Ç—å –ª—É–∫ –∏ –º–æ—Ä–∫–æ–≤—å\n–î–æ–±–∞–≤–∏—Ç—å —Ñ–∞—Ä—à, –∂–∞—Ä–∏—Ç—å 10 –º–∏–Ω—É—Ç\n–°–º–µ—à–∞—Ç—å —Å –≥—Ä–µ—á–∫–æ–π\n–ü–æ—Å–æ–ª–∏—Ç—å –∏ –ø–æ–¥–∞–≤–∞—Ç—å' },
        { id: 'demo-6', title: '–ü–µ–ª—å–º–µ–Ω–∏ –≤ –±—É–ª—å–æ–Ω–µ', sender: '–ü–∞–ø–∞', source: 'demo',
          body: '–ü–µ–ª—å–º–µ–Ω–∏ 400 –≥\n–í–æ–¥–∞ 1.5 –ª\n–õ–∞–≤—Ä–æ–≤—ã–π –ª–∏—Å—Ç 2 —à—Ç\n–°–æ–ª—å –ø–æ –≤–∫—É—Å—É\n–ü–µ—Ä–µ—Ü –≥–æ—Ä–æ—à–∫–æ–º 5 —à—Ç\n–í—Å–∫–∏–ø—è—Ç–∏—Ç—å –≤–æ–¥—É —Å –ª–∞–≤—Ä–æ–≤—ã–º –ª–∏—Å—Ç–æ–º –∏ –ø–µ—Ä—Ü–µ–º\n–ó–∞–±—Ä–æ—Å–∏—Ç—å –ø–µ–ª—å–º–µ–Ω–∏\n–í–∞—Ä–∏—Ç—å 7 –º–∏–Ω—É—Ç –ø–æ—Å–ª–µ –≤—Å–ø–ª—ã—Ç–∏—è\n–ü–æ–¥–∞–≤–∞—Ç—å –≤ –±—É–ª—å–æ–Ω–µ —Å–æ —Å–º–µ—Ç–∞–Ω–æ–π –∏ –∑–µ–ª–µ–Ω—å—é' },
        { id: 'demo-7', title: '–®–∞—Ä–ª–æ—Ç–∫–∞ –¥–æ–º–∞—à–Ω—è—è', sender: '–°–µ—Å—Ç—Ä–∞', source: 'demo',
          body: '–Ø–π—Ü–∞ 3 —à—Ç\n–°–∞—Ö–∞—Ä 200 –≥\n–ú—É–∫–∞ 200 –≥\n–Ø–±–ª–æ–∫–∏ 3 —à—Ç\n–ú–∞—Å–ª–æ —Å–ª–∏–≤–æ—á–Ω–æ–µ 10 –≥\n–í–∑–±–∏—Ç—å —è–π—Ü–∞ —Å —Å–∞—Ö–∞—Ä–æ–º –¥–æ –ø—ã—à–Ω–æ—Å—Ç–∏\n–ê–∫–∫—É—Ä–∞—Ç–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –º—É–∫—É\n–Ø–±–ª–æ–∫–∏ –Ω–∞—Ä–µ–∑–∞—Ç—å –¥–æ–ª—å–∫–∞–º–∏\n–í—ã–ª–æ–∂–∏—Ç—å —è–±–ª–æ–∫–∏ –≤ —Å–º–∞–∑–∞–Ω–Ω—É—é —Ñ–æ—Ä–º—É\n–ó–∞–ª–∏—Ç—å —Ç–µ—Å—Ç–æ–º\n–í—ã–ø–µ–∫–∞—Ç—å 180 –≥—Ä–∞–¥—É—Å–æ–≤ 35 –º–∏–Ω—É—Ç' },
        { id: 'demo-8', title: '–ü–ª–æ–≤ —Å–µ–º–µ–π–Ω—ã–π', sender: '–ë—Ä–∞—Ç', source: 'demo',
          body: '–†–∏—Å 400 –≥\n–ë–∞—Ä–∞–Ω–∏–Ω–∞ 500 –≥\n–ú–æ—Ä–∫–æ–≤—å 3 —à—Ç\n–õ—É–∫ 2 —à—Ç\n–ß–µ—Å–Ω–æ–∫ 1 —à—Ç\n–ó–∏—Ä–∞ 1 —á –ª\n–ú–∞—Å–ª–æ —Ä–∞—Å—Ç–∏—Ç–µ–ª—å–Ω–æ–µ 100 –º–ª\n–°–æ–ª—å –ø–æ –≤–∫—É—Å—É\n–†–∞–∑–æ–≥—Ä–µ—Ç—å –º–∞—Å–ª–æ –≤ –∫–∞–∑–∞–Ω–µ\n–û–±–∂–∞—Ä–∏—Ç—å –º—è—Å–æ –¥–æ –∫–æ—Ä–æ—á–∫–∏\n–î–æ–±–∞–≤–∏—Ç—å –ª—É–∫, –∑–∞—Ç–µ–º –º–æ—Ä–∫–æ–≤—å\n–ó–∞–ª–∏—Ç—å –≤–æ–¥–æ–π, —Ç—É—à–∏—Ç—å 40 –º–∏–Ω—É—Ç\n–î–æ–±–∞–≤–∏—Ç—å –∑–∏—Ä—É –∏ —Å–æ–ª—å\n–í—ã–ª–æ–∂–∏—Ç—å —Ä–∏—Å, –∑–∞–ª–∏—Ç—å –≤–æ–¥–æ–π –Ω–∞ 1 —Å–º –≤—ã—à–µ\n–ì–æ—Ç–æ–≤–∏—Ç—å –Ω–∞ —Å–ª–∞–±–æ–º –æ–≥–Ω–µ 25 –º–∏–Ω—É—Ç –Ω–µ –º–µ—à–∞—è\n–í–æ—Ç–∫–Ω—É—Ç—å —á–µ—Å–Ω–æ–∫ —Ü–µ–ª–∏–∫–æ–º\n–î–∞—Ç—å –Ω–∞—Å—Ç–æ—è—Ç—å—Å—è 15 –º–∏–Ω—É—Ç' }
      ];

      // Recipe list
      function getRecipes() {
        const responses = loadJSON('recipe_responses');
        const requests = loadJSON('recipe_requests');
        const userRecipes = responses.map(resp => {
          const req = requests.find(r => r.token === resp.token);
          return {
            id: 'r-' + resp.token,
            title: resp.title,
            sender: resp.sender || (req ? req.target_person : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'),
            body: resp.body,
            source: 'link',
            created_at: resp.created_at
          };
        });
        return [...userRecipes, ...demoRecipes];
      }

      function renderRecipeList() {
        recipeDetailEl.style.display = 'none';
        recipeListEl.style.display = '';

        const recipes = getRecipes();

        if (recipes.length === 0) {
          recipeListEl.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">üìñ</div>
              <div class="empty-state-text">–ü–æ–∫–∞ –Ω–µ—Ç —Ä–µ—Ü–µ–ø—Ç–æ–≤.<br>–ó–∞–ø—Ä–æ—Å–∏—Ç–µ –ø–µ—Ä–≤—ã–π —Ä–µ—Ü–µ–ø—Ç —É –±–ª–∏–∑–∫–∏—Ö!</div>
            </div>`;
          return;
        }

        recipeListEl.innerHTML = recipes.map(r => {
          const a = getAuthor(r.sender);
          const date = r.created_at ? `<span class="recipe-card-date">${formatDate(r.created_at)}</span>` : '';
          return `
          <div class="recipe-card" style="--author-color:${a.var}" data-id="${esc(r.id)}">
            <div class="recipe-card-title">${esc(r.title)}</div>
            <div class="recipe-card-meta">
              <span class="author-chip" style="background:${a.bg};color:${a.text}">–æ—Ç ${esc(r.sender)}</span>
              ${date}
            </div>
          </div>`;
        }).join('');

        recipeListEl.querySelectorAll('.recipe-card').forEach(card => {
          card.addEventListener('click', () => {
            const recipe = getRecipes().find(r => r.id === card.dataset.id);
            if (recipe) showDetail(recipe);
          });
        });
      }

      function showDetail(recipe) {
        recipeListEl.style.display = 'none';
        recipeDetailEl.style.display = '';

        const a = getAuthor(recipe.sender);
        recipeDetailEl.innerHTML = `
          <button class="detail-back" id="back-btn">&larr; –ù–∞–∑–∞–¥</button>
          <div class="detail-title">${esc(recipe.title)}</div>
          <div class="detail-author">${recipe.created_at ? formatDate(recipe.created_at) : ''}</div>
          <span class="detail-author-chip" style="background:${a.bg};color:${a.text}">–æ—Ç ${esc(recipe.sender)}</span>
          <div class="section-label">–û—Ä–∏–≥–∏–Ω–∞–ª</div>
          <div class="original-block">${esc(recipe.body)}</div>
          <div class="section-label">–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è</div>
          <div class="structured">${parseRecipe(recipe.body)}</div>
        `;

        document.getElementById('back-btn').addEventListener('click', renderRecipeList);
      }

      renderRecipeList();

      // --- Request form ---
      const reqTarget = document.getElementById('req-target');
      const reqTitle = document.getElementById('req-title');
      const createBtn = document.getElementById('create-link');
      const linkResult = document.getElementById('link-result');
      const requestListEl = document.getElementById('request-list');

      function renderRequestList() {
        const requests = loadJSON('recipe_requests');
        if (requests.length === 0) {
          requestListEl.innerHTML = `
            <div class="empty-state" style="padding:30px 0">
              <div class="empty-state-text">–ù–µ—Ç –∑–∞–ø—Ä–æ—Å–æ–≤</div>
            </div>`;
          return;
        }

        requestListEl.innerHTML = requests.map(r => {
          const link = buildLink(r.token);
          const statusClass = r.status === 'fulfilled' ? 'badge-fulfilled' : 'badge-pending';
          const statusText = r.status === 'fulfilled' ? '–ø–æ–ª—É—á–µ–Ω' : '–æ–∂–∏–¥–∞–µ—Ç';
          return `
            <div class="request-item">
              <button class="request-delete" data-token="${esc(r.token)}">‚úï</button>
              <div class="request-item-title">${esc(r.requested_title)}</div>
              <div class="request-item-info">
                <span>–£ –∫–æ–≥–æ: ${esc(r.target_person)} ¬∑ ${formatDate(r.created_at)}</span>
                <span class="badge ${statusClass}">${statusText}</span>
              </div>
              <div class="request-item-link" data-link="${esc(link)}">${esc(link)}</div>
            </div>`;
        }).join('');

        requestListEl.querySelectorAll('.request-delete').forEach(btn => {
          btn.addEventListener('click', () => {
            const requests = loadJSON('recipe_requests');
            saveJSON('recipe_requests', requests.filter(r => r.token !== btn.dataset.token));
            renderRequestList();
          });
        });

        requestListEl.querySelectorAll('.request-item-link').forEach(el => {
          el.addEventListener('click', () => {
            navigator.clipboard.writeText(el.dataset.link).then(() => {
              const orig = el.textContent;
              el.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
              setTimeout(() => { el.textContent = orig; }, 1500);
            });
          });
        });
      }

      createBtn.addEventListener('click', () => {
        const target = reqTarget.value.trim();
        const title = reqTitle.value.trim();
        if (!target || !title) return;

        const token = crypto.randomUUID();
        const request = {
          id: Date.now(),
          token,
          requester: '–Ø',
          target_person: target,
          requested_title: title,
          status: 'pending',
          created_at: new Date().toISOString()
        };

        const requests = loadJSON('recipe_requests');
        requests.unshift(request);
        saveJSON('recipe_requests', requests);

        const link = buildLink(token);
        linkResult.innerHTML = `
          <div class="link-box" id="copy-link" data-link="${esc(link)}">
            ${esc(link)}
            <div class="link-hint">–ù–∞–∂–º–∏—Ç–µ —á—Ç–æ–±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</div>
          </div>`;

        document.getElementById('copy-link').addEventListener('click', function() {
          navigator.clipboard.writeText(this.dataset.link).then(() => {
            this.querySelector('.link-hint').textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
            setTimeout(() => { this.querySelector('.link-hint').textContent = '–ù–∞–∂–º–∏—Ç–µ —á—Ç–æ–±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å'; }, 1500);
          });
        });

        reqTarget.value = '';
        reqTitle.value = '';
        renderRequestList();
      });

      renderRequestList();
    }
  </script>

</body>
</html>
