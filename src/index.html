<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Семейные рецепты</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      height: 100vh;
      display: flex; justify-content: center; align-items: center; gap: 32px;
      background: #e8e8ed;
    }

    .phone {
      width: 375px; height: min(812px, calc(100vh - 80px));
      border-radius: 40px;
      background: #fff;
      box-shadow: 0 8px 40px rgba(0,0,0,.18), inset 0 0 0 3px #d1d1d6;
      display: flex; flex-direction: column;
      overflow: hidden;
      position: relative;
    }

    .phone-notch {
      width: 150px; height: 28px;
      background: #000; border-radius: 0 0 18px 18px;
      margin: 0 auto;
      position: relative; z-index: 1;
    }

    .phone-screen {
      flex: 1; padding: 16px 20px 24px;
      display: flex; flex-direction: column;
      overflow-y: auto;
    }

    .phone-mom .phone-screen { background: #fafafa; }
    .phone-son .phone-screen { background: #fff; }

    .phone-label {
      text-align: center; font-size: 13px; font-weight: 600;
      color: #666; margin-top: 12px; letter-spacing: 0.5px;
    }

    h1 { font-size: 20px; margin-bottom: 16px; }

    label { display: block; font-weight: 500; margin-bottom: 4px; font-size: 14px; }
    input[type="text"] {
      width: 100%; padding: 10px 12px; font-size: 15px;
      border: 1px solid #ccc; border-radius: 10px; margin-bottom: 12px;
    }
    textarea {
      width: 100%; flex: 1; padding: 12px; font-size: 15px;
      border: 1px solid #ccc; border-radius: 10px; resize: none;
      margin-bottom: 12px; min-height: 160px;
    }
    button {
      padding: 12px 24px; font-size: 15px; font-weight: 600;
      background: #007aff; color: #fff; border: none; border-radius: 12px;
      cursor: pointer; align-self: stretch; text-align: center;
    }
    button:hover { background: #0066d6; }

    .status { margin-top: 10px; color: #2e7d32; font-weight: 500; font-size: 14px; text-align: center; }

    .tabs {
      display: flex; gap: 0; margin-bottom: 16px;
      border-bottom: 2px solid #e0e0e0;
    }
    .tab {
      flex: 1; padding: 10px 0; font-size: 14px; font-weight: 600;
      background: none; color: #999; border: none; border-bottom: 2px solid transparent;
      margin-bottom: -2px; cursor: pointer; border-radius: 0;
    }
    .tab:hover { color: #666; background: none; }
    .tab.active { color: #007aff; border-bottom-color: #007aff; }

    .tab-content { display: none; flex-direction: column; flex: 1; }
    .tab-content.active { display: flex; }

    .sent-list { list-style: none; padding: 0; }
    .sent-item {
      padding: 12px; margin-bottom: 8px;
      background: #f5f5f5; border-radius: 10px;
    }
    .sent-item-title { font-weight: 600; font-size: 14px; margin-bottom: 4px; }
    .sent-item-recipient { font-size: 12px; color: #007aff; margin-bottom: 4px; }
    .sent-item-preview { font-size: 13px; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    .recipient-toggle {
      display: flex; gap: 0; margin-bottom: 12px;
      background: #f0f0f5; border-radius: 10px; padding: 3px;
    }
    .recipient-btn {
      flex: 1; padding: 8px 0; font-size: 14px; font-weight: 600;
      background: none; color: #666; border: none; border-radius: 8px;
      cursor: pointer;
    }
    .recipient-btn:hover { background: none; color: #333; }
    .recipient-btn.active { background: #fff; color: #007aff; box-shadow: 0 1px 4px rgba(0,0,0,.1); }

    .empty { color: #999; font-style: italic; margin-top: 60px; text-align: center; font-size: 15px; }

    .filter-bar {
      display: flex; gap: 6px; margin-bottom: 12px; flex-wrap: wrap;
    }
    .filter-chip {
      padding: 6px 12px; font-size: 12px; font-weight: 600;
      border: none; border-radius: 16px; cursor: pointer;
      background: #f0f0f5; color: #666;
    }
    .filter-chip:hover { opacity: 0.8; }
    .filter-chip.active { color: #fff; }

    .recipe-card {
      padding: 10px 12px; margin-bottom: 8px;
      border-radius: 10px; background: #f9f9f9;
      cursor: pointer; border-left: 4px solid transparent;
      transition: background 0.15s;
    }
    .recipe-card:hover { background: #f0f0f5; }
    .recipe-card-title { font-weight: 600; font-size: 14px; margin-bottom: 2px; }
    .recipe-card-sender {
      display: inline-block; font-size: 11px; font-weight: 600;
      padding: 2px 8px; border-radius: 10px; color: #fff; margin-bottom: 4px;
    }
    .recipe-card-preview { font-size: 13px; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    .detail-back {
      padding: 6px 0; font-size: 14px; font-weight: 500;
      background: none; color: #007aff; border: none; cursor: pointer;
      text-align: left; align-self: flex-start; margin-bottom: 8px; border-radius: 0;
    }
    .detail-back:hover { background: none; text-decoration: underline; }

    .original {
      background: #f5f0e8; border-left: 3px solid #c9a96e;
      padding: 12px; border-radius: 8px; white-space: pre-wrap;
      font-size: 14px; line-height: 1.5; margin-bottom: 16px;
    }
    .original-label, .structured-label {
      font-weight: 600; font-size: 12px; text-transform: uppercase;
      letter-spacing: 0.5px; color: #888; margin-bottom: 6px;
    }

    .structured { font-size: 14px; line-height: 1.5; }
    .structured h3 { font-size: 15px; margin: 12px 0 6px; }
    .structured h3:first-child { margin-top: 0; }
    .structured ul, .structured ol { padding-left: 18px; }
    .structured li { margin-bottom: 3px; }

    .link-box {
      margin-top: 10px; padding: 10px; background: #e8f5e9;
      border-radius: 10px; word-break: break-all; font-size: 13px;
      cursor: pointer; position: relative;
    }
    .link-box:hover { background: #c8e6c9; }
    .link-box-hint { font-size: 11px; color: #666; margin-top: 4px; }

    .request-item {
      padding: 10px 12px; margin-bottom: 8px;
      background: #f5f5f5; border-radius: 10px;
    }
    .request-item-title { font-weight: 600; font-size: 14px; margin-bottom: 2px; }
    .request-item-meta { font-size: 12px; color: #888; margin-bottom: 4px; }
    .request-item-link {
      font-size: 12px; color: #007aff; word-break: break-all;
      cursor: pointer;
    }
    .request-item-link:hover { text-decoration: underline; }
    .request-status { font-size: 11px; font-weight: 600; padding: 2px 8px; border-radius: 10px; background: #fff3e0; color: #e65100; }
    .request-status.fulfilled { background: #e8f5e9; color: #2e7d32; }

    .reply-screen {
      display: none; max-width: 400px; width: 100%;
      margin: 0 auto; padding: 32px 20px;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }
    .reply-screen h1 { font-size: 22px; margin-bottom: 8px; }
    .reply-info {
      background: #f5f0e8; border-left: 3px solid #c9a96e;
      padding: 12px; border-radius: 8px; margin-bottom: 20px;
      font-size: 14px; line-height: 1.5;
    }
    .reply-info strong { display: block; margin-bottom: 4px; }
    .reply-success {
      text-align: center; padding: 40px 20px;
    }
    .reply-success h2 { color: #2e7d32; margin-bottom: 8px; }
    .reply-error {
      text-align: center; padding: 60px 20px;
    }
    .reply-error h2 { color: #c62828; margin-bottom: 8px; }

    @media (max-width: 840px) {
      body { flex-direction: column; height: auto; padding: 16px; gap: 16px; }
      .phone { width: 100%; max-width: 375px; height: 700px; }
    }
  </style>
</head>
<body>

  <!-- Ответ на запрос (по ссылке ?r=token) -->
  <div class="reply-screen" id="reply-screen"></div>

  <!-- Мама -->
  <div>
    <div class="phone phone-mom">
      <div class="phone-notch"></div>
      <div class="phone-screen">
        <h1>Мама</h1>
        <div class="tabs">
          <button class="tab active" data-tab="new">Новый рецепт</button>
          <button class="tab" data-tab="sent">Отправленные</button>
        </div>
        <div class="tab-content active" id="tab-new">
          <label for="title">Название рецепта</label>
          <input type="text" id="title" placeholder="Например: Борщ бабушкин">
          <label for="body">Рецепт</label>
          <textarea id="body" placeholder="Пиши как в мессенджере — свободно, своими словами…"></textarea>
          <label>Кому</label>
          <div class="recipient-toggle">
            <button class="recipient-btn active" data-recipient="son">Сыну</button>
            <button class="recipient-btn" data-recipient="daughter">Дочке</button>
          </div>
          <button id="send">Отправить</button>
          <div class="status" id="status"></div>
        </div>
        <div class="tab-content" id="tab-sent">
          <ul class="sent-list" id="sent-list"></ul>
          <p class="empty" id="sent-empty">Пока ничего не отправлено</p>
        </div>
      </div>
    </div>
    <div class="phone-label">Передатчик</div>
  </div>

  <!-- Получатель -->
  <div>
    <div class="phone phone-son">
      <div class="phone-notch"></div>
      <div class="phone-screen">
        <h1>Рецепты от семьи</h1>
        <div class="tabs">
          <button class="tab active" data-master-tab="recipes">Рецепты</button>
          <button class="tab" data-master-tab="request">Запросить</button>
        </div>
        <div class="tab-content active" id="master-tab-recipes">
          <div class="filter-bar" id="filter-bar"></div>
          <div id="recipe-list"></div>
          <div id="recipe-detail" style="display:none"></div>
        </div>
        <div class="tab-content" id="master-tab-request">
          <label for="req-target">У кого просим</label>
          <input type="text" id="req-target" placeholder="Например: Мама">
          <label for="req-title">Название блюда</label>
          <input type="text" id="req-title" placeholder="Например: Борщ">
          <button id="create-link">Создать ссылку</button>
          <div id="link-result"></div>
          <div id="request-list" style="margin-top:16px"></div>
        </div>
      </div>
    </div>
    <div class="phone-label">Мастер</div>
  </div>

  <script>
    // --- Reply flow: ?r=<token> ---
    const urlParams = new URLSearchParams(window.location.search);
    const replyToken = urlParams.get('r');

    if (replyToken) {
      // Hide both phones
      document.querySelectorAll('body > div').forEach(div => {
        if (div.querySelector('.phone')) div.style.display = 'none';
      });

      const replyScreen = document.getElementById('reply-screen');
      replyScreen.style.display = 'block';

      // Escape helper (needed before main code)
      function escReply(str) {
        const d = document.createElement('div');
        d.textContent = str;
        return d.innerHTML;
      }

      let requests = [];
      try { requests = JSON.parse(localStorage.getItem('recipe_requests') || '[]'); } catch {}
      const request = requests.find(r => r.token === replyToken);

      if (!request) {
        replyScreen.innerHTML = `
          <div class="reply-error">
            <h2>Запрос не найден</h2>
            <p style="color:#888">Ссылка недействительна или запрос был удалён.</p>
          </div>`;
      } else if (request.status === 'fulfilled') {
        replyScreen.innerHTML = `
          <div class="reply-success">
            <h2>Рецепт уже отправлен</h2>
            <p style="color:#888">На этот запрос уже был дан ответ.</p>
          </div>`;
      } else {
        replyScreen.innerHTML = `
          <h1>Запрос рецепта</h1>
          <div class="reply-info">
            <strong>${escReply(request.target_person)}, вас просят поделиться рецептом:</strong>
            ${escReply(request.requested_title)}
          </div>
          <label for="reply-title">Название рецепта</label>
          <input type="text" id="reply-title" value="${escReply(request.requested_title)}">
          <label for="reply-body">Рецепт</label>
          <textarea id="reply-body" placeholder="Напишите рецепт своими словами…" style="min-height:200px"></textarea>
          <button id="reply-submit">Отправить рецепт</button>
          <div class="status" id="reply-status"></div>`;

        document.getElementById('reply-submit').addEventListener('click', () => {
          const body = document.getElementById('reply-body').value.trim();
          const title = document.getElementById('reply-title').value.trim();
          const statusEl = document.getElementById('reply-status');

          if (!body) {
            statusEl.style.color = '#c62828';
            statusEl.textContent = 'Напишите рецепт перед отправкой';
            return;
          }

          // Save response
          let responses = [];
          try { responses = JSON.parse(localStorage.getItem('recipe_responses') || '[]'); } catch {}
          responses.push({
            token: replyToken,
            title: title || request.requested_title,
            body: body,
            created_at: new Date().toISOString()
          });
          localStorage.setItem('recipe_responses', JSON.stringify(responses));

          // Update request status
          request.status = 'fulfilled';
          localStorage.setItem('recipe_requests', JSON.stringify(requests));

          // Show success
          replyScreen.innerHTML = `
            <div class="reply-success">
              <h2>Рецепт отправлен!</h2>
              <p style="color:#888">Спасибо, ваш рецепт «${escReply(title || request.requested_title)}» сохранён.</p>
            </div>`;
        });
      }
    }
    // --- End reply flow ---

    const titleInput = document.getElementById('title');
    const bodyInput = document.getElementById('body');
    const sendBtn = document.getElementById('send');
    const status = document.getElementById('status');
    const sentList = document.getElementById('sent-list');
    const sentEmpty = document.getElementById('sent-empty');
    const recipeListEl = document.getElementById('recipe-list');
    const recipeDetailEl = document.getElementById('recipe-detail');
    const filterBar = document.getElementById('filter-bar');

    // Табы мамы (Новый рецепт / Отправленные)
    document.querySelectorAll('.phone-mom .tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.phone-mom .tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        document.querySelectorAll('.phone-mom .tab-content').forEach(c => c.classList.remove('active'));
        document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
      });
    });

    // Выбор получателя у мамы
    let selectedRecipient = 'son';
    const recipientLabels = { son: 'сыну', daughter: 'дочке' };

    document.querySelectorAll('.recipient-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.recipient-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        selectedRecipient = btn.dataset.recipient;
      });
    });

    // Экранирование HTML
    function esc(str) {
      const d = document.createElement('div');
      d.textContent = str;
      return d.innerHTML;
    }

    // Парсинг маминого текста в структурированную версию
    function parseRecipe(text) {
      const lines = text.split('\n').map(l => l.trim()).filter(l => l.length > 0);
      if (lines.length === 0) return '<p style="color:#999">Пусто — нечего разбирать</p>';

      const unitPattern = /\d+\s*(г|гр|кг|мл|л|шт|ст\.?\s*л|ч\.?\s*л|стакан|щепот|пучок|зубч|долек|долька|банк|пачк|упаковк)/i;
      const tastePattern = /по вкусу|на глаз/i;

      const ingredients = [];
      const steps = [];

      for (const line of lines) {
        if (unitPattern.test(line) || tastePattern.test(line)) {
          ingredients.push(line);
        } else {
          steps.push(line);
        }
      }

      let html = '';
      if (ingredients.length > 0) {
        html += '<h3>Ингредиенты</h3><ul>';
        for (const ing of ingredients) html += `<li>${esc(ing)}</li>`;
        html += '</ul>';
      }
      if (steps.length > 0) {
        html += '<h3>Шаги</h3><ol>';
        for (const step of steps) html += `<li>${esc(step)}</li>`;
        html += '</ol>';
      }
      if (!html) html = '<p style="color:#999">Не удалось разобрать</p>';
      return html;
    }

    // --- Данные получателя ---
    const senderColors = {
      'Мама': '#FF6B6B',
      'Папа': '#4D96FF',
      'Брат': '#6BCB77',
      'Сестра': '#FFD93D'
    };

    const allRecipes = [
      { id: 1, title: 'Яичница по-польски', sender: 'Мама',
        body: 'Яйца 3 шт\nМасло сливочное 20 г\nХлеб белый 2 шт\nСоль по вкусу\nРазогреть сковороду с маслом\nРазбить яйца, не перемешивать\nНакрыть крышкой на 3 минуты\nПодавать с поджаренным хлебом' },
      { id: 2, title: 'Котлеты свиные', sender: 'Папа',
        body: 'Свинина 500 г\nЛук 1 шт\nЧеснок 2 зубч\nХлеб 100 г\nЯйцо 1 шт\nСоль по вкусу\nПеремолоть мясо с луком и чесноком\nДобавить размоченный хлеб и яйцо\nСформировать котлеты\nОбжарить по 5 минут с каждой стороны\nДовести под крышкой 10 минут' },
      { id: 3, title: 'Борщ выходного дня', sender: 'Мама',
        body: 'Говядина 400 г\nСвёкла 1 шт\nКартошка 3 шт\nКапуста 300 г\nМорковь 1 шт\nЛук 1 шт\nТоматная паста 1 ст л\nВода 2 л\nСоль по вкусу\nСварить бульон из мяса полтора часа\nНатереть свёклу, обжарить с томатной пастой\nКартошку нарезать кубиками, капусту нашинковать\nВ бульон добавить картошку, варить 10 минут\nДобавить капусту и свёклу, варить ещё 10 минут\nЛук и морковь обжарить, добавить в борщ\nПосолить, дать настояться 20 минут' },
      { id: 4, title: 'Сырники утренние', sender: 'Сестра',
        body: 'Творог 400 г\nЯйцо 1 шт\nСахар 2 ст л\nМука 3 ст л\nСоль на глаз\nСмешать творог с яйцом и сахаром\nДобавить муку, перемешать\nСформировать лепёшки\nОбжарить на среднем огне по 3 минуты с каждой стороны\nПодавать со сметаной' },
      { id: 5, title: 'Гречка по-флотски', sender: 'Брат',
        body: 'Гречка 200 г\nФарш 300 г\nЛук 1 шт\nМорковь 1 шт\nМасло растительное 2 ст л\nСоль по вкусу\nСварить гречку до готовности\nОбжарить лук и морковь\nДобавить фарш, жарить 10 минут\nСмешать с гречкой\nПосолить и подавать' },
      { id: 6, title: 'Пельмени в бульоне', sender: 'Папа',
        body: 'Пельмени 400 г\nВода 1.5 л\nЛавровый лист 2 шт\nСоль по вкусу\nПерец горошком 5 шт\nВскипятить воду с лавровым листом и перцем\nЗабросить пельмени\nВарить 7 минут после всплытия\nПодавать в бульоне со сметаной и зеленью' },
      { id: 7, title: 'Шарлотка домашняя', sender: 'Сестра',
        body: 'Яйца 3 шт\nСахар 200 г\nМука 200 г\nЯблоки 3 шт\nМасло сливочное 10 г\nВзбить яйца с сахаром до пышности\nАккуратно добавить муку\nЯблоки нарезать дольками\nВыложить яблоки в смазанную форму\nЗалить тестом\nВыпекать 180 градусов 35 минут' },
      { id: 8, title: 'Плов семейный', sender: 'Брат',
        body: 'Рис 400 г\nБаранина 500 г\nМорковь 3 шт\nЛук 2 шт\nЧеснок 1 шт\nЗира 1 ч л\nМасло растительное 100 мл\nСоль по вкусу\nРазогреть масло в казане\nОбжарить мясо до корочки\nДобавить лук, затем морковь\nЗалить водой, тушить 40 минут\nДобавить зиру и соль\nВыложить рис, залить водой на 1 см выше\nГотовить на слабом огне 25 минут не мешая\nВоткнуть чеснок целиком\nДать настояться 15 минут' }
    ];

    let currentFilter = 'all';

    // Фильтры
    function renderFilters() {
      const senders = ['all', ...Object.keys(senderColors)];
      filterBar.innerHTML = senders.map(s => {
        const isActive = s === currentFilter;
        const label = s === 'all' ? 'Все' : s;
        const bg = s === 'all' ? (isActive ? '#007aff' : '#f0f0f5') : (isActive ? senderColors[s] : '#f0f0f5');
        const color = isActive ? '#fff' : '#666';
        return `<button class="filter-chip ${isActive ? 'active' : ''}" data-filter="${esc(s)}" style="background:${bg};color:${color}">${esc(label)}</button>`;
      }).join('');

      filterBar.querySelectorAll('.filter-chip').forEach(chip => {
        chip.addEventListener('click', () => {
          currentFilter = chip.dataset.filter;
          renderFilters();
          renderRecipeList();
        });
      });
    }

    // Список рецептов
    function renderRecipeList() {
      recipeDetailEl.style.display = 'none';
      recipeListEl.style.display = '';

      const filtered = currentFilter === 'all' ? allRecipes : allRecipes.filter(r => r.sender === currentFilter);

      if (filtered.length === 0) {
        recipeListEl.innerHTML = '<p class="empty">Нет рецептов</p>';
        return;
      }

      recipeListEl.innerHTML = filtered.map(r => `
        <div class="recipe-card" data-id="${r.id}" style="border-left-color:${senderColors[r.sender]}">
          <span class="recipe-card-sender" style="background:${senderColors[r.sender]}">${esc(r.sender)}</span>
          <div class="recipe-card-title">${esc(r.title)}</div>
          <div class="recipe-card-preview">${esc(r.body.split('\n').slice(0, 2).join(', '))}</div>
        </div>
      `).join('');

      recipeListEl.querySelectorAll('.recipe-card').forEach(card => {
        card.addEventListener('click', () => {
          const recipe = allRecipes.find(r => r.id === Number(card.dataset.id));
          if (recipe) showRecipeDetail(recipe);
        });
      });
    }

    // Детали рецепта
    function showRecipeDetail(recipe) {
      recipeListEl.style.display = 'none';
      recipeDetailEl.style.display = '';

      recipeDetailEl.innerHTML = `
        <button class="detail-back" id="back-to-list">&larr; Назад</button>
        <span class="recipe-card-sender" style="background:${senderColors[recipe.sender]};margin-bottom:8px">${esc(recipe.sender)}</span>
        <h2 style="margin-bottom:16px">${esc(recipe.title)}</h2>
        <div class="original-label">Оригинал</div>
        <div class="original">${esc(recipe.body)}</div>
        <div class="structured-label">Структурированная версия</div>
        <div class="structured">${parseRecipe(recipe.body)}</div>
      `;

      document.getElementById('back-to-list').addEventListener('click', () => {
        renderRecipeList();
      });
    }

    // Табы мастера (Рецепты / Запросить)
    document.querySelectorAll('.phone-son .tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.phone-son .tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        document.querySelectorAll('.phone-son .tab-content').forEach(c => c.classList.remove('active'));
        document.getElementById('master-tab-' + tab.dataset.masterTab).classList.add('active');
      });
    });

    // --- Запросы рецептов ---
    const reqTargetInput = document.getElementById('req-target');
    const reqTitleInput = document.getElementById('req-title');
    const createLinkBtn = document.getElementById('create-link');
    const linkResultEl = document.getElementById('link-result');
    const requestListEl = document.getElementById('request-list');

    function loadRequests() {
      try {
        return JSON.parse(localStorage.getItem('recipe_requests') || '[]');
      } catch { return []; }
    }

    function saveRequests(requests) {
      localStorage.setItem('recipe_requests', JSON.stringify(requests));
    }

    function buildRequestLink(token) {
      const base = window.location.href.split('?')[0];
      return base + '?r=' + token;
    }

    function renderRequestList() {
      const requests = loadRequests();
      if (requests.length === 0) {
        requestListEl.innerHTML = '<p class="empty" style="margin-top:20px">Нет запросов</p>';
        return;
      }
      requestListEl.innerHTML = requests.map(r => {
        const link = buildRequestLink(r.token);
        const date = new Date(r.created_at).toLocaleDateString('ru-RU');
        return `<div class="request-item">
          <div class="request-item-title">${esc(r.requested_title)}</div>
          <div class="request-item-meta">У кого: ${esc(r.target_person)} · ${date} <span class="request-status ${r.status === 'fulfilled' ? 'fulfilled' : ''}">${r.status === 'fulfilled' ? 'выполнен' : 'ожидает'}</span></div>
          <div class="request-item-link" data-link="${esc(link)}">${esc(link)}</div>
        </div>`;
      }).join('');

      requestListEl.querySelectorAll('.request-item-link').forEach(el => {
        el.addEventListener('click', () => {
          navigator.clipboard.writeText(el.dataset.link).then(() => {
            const orig = el.textContent;
            el.textContent = 'Скопировано!';
            setTimeout(() => { el.textContent = orig; }, 1500);
          });
        });
      });
    }

    createLinkBtn.addEventListener('click', () => {
      const target = reqTargetInput.value.trim();
      const title = reqTitleInput.value.trim();
      if (!target || !title) return;

      const token = crypto.randomUUID();
      const request = {
        id: Date.now(),
        token,
        requester: 'Я',
        target_person: target,
        requested_title: title,
        status: 'pending',
        created_at: new Date().toISOString()
      };

      const requests = loadRequests();
      requests.unshift(request);
      saveRequests(requests);

      const link = buildRequestLink(token);
      linkResultEl.innerHTML = `<div class="link-box" id="copy-link" data-link="${esc(link)}">${esc(link)}<div class="link-box-hint">Нажмите чтобы скопировать</div></div>`;
      document.getElementById('copy-link').addEventListener('click', function() {
        navigator.clipboard.writeText(this.dataset.link).then(() => {
          this.querySelector('.link-box-hint').textContent = 'Скопировано!';
          setTimeout(() => { this.querySelector('.link-box-hint').textContent = 'Нажмите чтобы скопировать'; }, 1500);
        });
      });

      reqTargetInput.value = '';
      reqTitleInput.value = '';
      renderRequestList();
    });

    // Init правая панель
    renderFilters();
    renderRecipeList();
    renderRequestList();

    // --- Мамина отправка ---
    sendBtn.addEventListener('click', () => {
      const title = titleInput.value.trim();
      const body = bodyInput.value.trim();

      if (!body) return;

      const recipient = selectedRecipient;
      const recipientName = recipient === 'son' ? 'Сыну' : 'Дочке';

      // Сохранить в отправленные
      sentEmpty.style.display = 'none';
      const li = document.createElement('li');
      li.className = 'sent-item';
      li.innerHTML = `<div class="sent-item-recipient">${esc(recipientName)}</div><div class="sent-item-title">${esc(title || 'Без названия')}</div><div class="sent-item-preview">${esc(body)}</div>`;
      sentList.prepend(li);

      // Показать статус у мамы
      status.textContent = `Отправлено ${recipientLabels[recipient]}!`;

      // Добавить в общий список рецептов получателя
      allRecipes.unshift({
        id: Date.now(),
        title: title || 'Без названия',
        sender: 'Мама',
        body: body
      });
      renderRecipeList();
    });
  </script>

</body>
</html>
